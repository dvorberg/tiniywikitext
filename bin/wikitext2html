#!/Users/diedrich/t4wiki/virtualenv.nosync.noindex/bin/python

import sys, time, argparse, pathlib

from tinywikitext import to_html
from tinywikitext.macro import macro_library
from tinymarkup.context import Context

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--outfile", "-o",
                        nargs='?', type=argparse.FileType('w'),
                        default=sys.stdout)
    parser.add_argument("infilepaths", nargs="+", type=pathlib.Path)
    args = parser.parse_args()

    print('<!DOCTYPE html>',
          '<html>',
          '<head>',
          '<title></title>',
          '<meta charset="utf-8">',
          '</head>',
          '<body>',
          sep="\n", file=args.outfile)

    def process(infilepath):
        with infilepath.open() as fp:
            wikitext = fp.read()

        print(infilepath.name, end=" ", file=sys.stderr)

        parse_start = time.time()
        try:
            html = to_html(args.outfile, wikitext, Context(macro_library))
        except:
            print("\n", file=sys.stderr)
            raise

        parse_end = time.time()

        print("Conversion time: %.4f sec" % (parse_end-parse_start,),
              file=sys.stderr)

    for infilepath in args.infilepaths:
        process(infilepath)

    print('</body>',
          '</html>',
          sep="\n", file=args.outfile)

    args.outfile.close()

main()
